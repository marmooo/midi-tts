function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}class SoundFontPlayer{constructor(e){this.context=new AudioContext,this.state="stopped",this.callStop=!1,this.stopCallback=e,this.prevGain=5,this.cacheUrls=new Array(128),this.totalTicks=0}async loadSoundFontDir(e,t){const n=e.map(e=>{const s=e.toString().padStart(3,"0"),n=`${t}/${s}.sf3`;return this.cacheUrls[e]==n||(this.cacheUrls[e]=n,this.fetchBuffer(n))}),s=await Promise.all(n);for(const e of s)e instanceof ArrayBuffer&&await this.loadSoundFontBuffer(e)}async fetchBuffer(e){const t=await fetch(e);return t.status==200?await t.arrayBuffer():void 0}async loadSoundFontUrl(e){const t=await this.fetchBuffer(e),n=await this.loadSoundFontBuffer(t);return n}async loadSoundFontBuffer(e){if(!this.synth){await JSSynthPromise,await this.context.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/externals/libfluidsynth-2.3.0-with-libsndfile.min.js"),await this.context.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/dist/js-synthesizer.worklet.min.js"),this.synth=new JSSynth.AudioWorkletNodeSynthesizer,this.synth.init(this.context.sampleRate);const e=this.synth.createAudioNode(this.context);e.connect(this.context.destination)}const t=await this.synth.loadSFont(e);return t}async loadNoteSequence(e){await this.synth.resetPlayer(),this.totalTicks=1/0;const t=document.getElementById("volume"),n=parseInt(t.value);return this.changeVolume(n),this.synth.addSMFDataToPlayer(e)}resumeContext(){this.context.resume()}async restart(e){this.state="started",await this.synth.playPlayer(),e&&this.seekTo(e),await this.synth.waitForPlayerStopped(),await this.synth.waitForVoicesStopped(),this.state="paused";const t=await this.synth.retrievePlayerCurrentTick();this.totalTicks<=t&&(player.seekTo(0),this.stopCallback())}async start(e,t,n){e&&await this.loadNoteSequence(e),n&&this.seekTo(n),this.restart()}stop(){this.isPlaying()&&this.synth.stopPlayer()}pause(){this.state="paused",this.synth.stopPlayer()}resume(e){this.restart(e)}changeVolume(e){e=e/100,this.synth.setGain(e)}changeMute(e){e?(this.prevGain=this.synth.getGain(),this.synth.setGain(0)):this.synth.setGain(this.prevGain)}calcTick(e){let t=0,n=0,s=120;for(const i of this.ns.tempos){const o=i.time,a=i.qpm;if(o<e){const e=o-n;t+=s/60*e*this.ns.ticksPerQuarter}else{const o=e-n;return t+=s/60*o*this.ns.ticksPerQuarter,Math.round(t)}n=o,s=a}const o=e-n;return t+=s/60*o*this.ns.ticksPerQuarter,Math.floor(t)}seekTo(e){const t=this.calcTick(e);this.synth.seekPlayer(t)}isPlaying(){return!!this.synth&&this.synth.isPlaying()}getPlayState(){return this.synth?this.synth.isPlaying()?"started":this.state:"stopped"}}function stopCallback(){clearInterval(timer),currentTime=0,currentPos=0,clearPlayer()}async function initPlayer(){disableController(),player&&player.isPlaying()&&player.stop(),currentTime=0,currentPos=0,player=new SoundFontPlayer(stopCallback),firstRun?(firstRun=!1,await loadSoundFont(player,"Ritsu_v0.0.2.sf3")):await loadSoundFont(player),enableController()}async function loadSoundFont(e,t){await e.loadSoundFontUrl(t)}function disableController(){controllerDisabled=!0;const e=document.getElementById("controller").querySelectorAll("button, input");[...e].forEach(e=>{e.disabled=!0})}function enableController(){controllerDisabled=!1;const e=document.getElementById("controller").querySelectorAll("button, input");[...e].forEach(e=>{e.disabled=!1})}function unlockAudio(){if(!player)return;if(!player.synth)return;player.resumeContext(),document.removeEventListener("click",unlockAudio)}function play(){player.start()}function changeVolumebar(){const e=document.getElementById("volume"),t=parseInt(e.value);e.dataset.value=t,player.changeVolume(t)}function clearPlayer(){clearInterval(timer)}function typeEvent(e){if(!player||!player.synth)return;if(controllerDisabled)return;player.resumeContext(),e.keyCode===13&&tts()}function initMoras(){fetch("mora.lst").then(e=>e.text()).then(e=>{e.trimEnd().split(`
`).forEach((e,t)=>{moraMap.set(e,t)})})}function getNotes(e,t){const o=parseInt(document.getElementById("pitch").value),i=parseInt(document.getElementById("volume").value),c=2,n=[];let a=o,r=i,s="0";for(;t.length>0;){let l=!1;for(let d=c;0<d;d--){const u=t.slice(0,d);if(e.has(u)){const c={instrument:e.get(u),duration:"4",pitch:a,velocity:r,wait:s};n.push(structuredClone(c)),a=o,r=i,s="0",t=t.substring(u.length),l=!0;break}}if(!l){switch(t[0]){case" ":s="16";break;case"　":s="8";break;case"っ":s="4";break;case"…":case"･･･":case"、":case"､":case"，":case",":s="2n";break;case"。":case"｡":case"．":case".":s="1n";break;case"↑":case"↗":case"⤴":case"⇑":case"⇡":n.at(-1).pitch+=1;break;case"⬆":n.at(-1).pitch+=4;break;case"↓":case"↘":case"⤵":case"⇓":case"⇣":n.at(-1).pitch-=1;break;case"⬇":n.at(-1).pitch-=4;break;case"!":n.at(-1).velocity+=8;break;case"‼":case"!!":n.at(-1).velocity+=16;break;case"！":n.at(-1).velocity+=32;break;case"❗":case"❕":n.at(-1).velocity+=64;break;case"?":{const e=structuredClone(n.at(-1));e.duration="32",e.pitch+=1,n.push(e);break}case"??":case"?!":case"!?":case"？":case"❓":case"❔":{const e=structuredClone(n.at(-1));e.duration="16",e.pitch+=1,n.push(e);break}case"ー":n.at(-1).duration="2";break}t=t.substring(1)}}return n}function kanaToHira(e){return e.replace(/[\u30a1-\u30f6]/g,e=>{const t=e.charCodeAt(0)-96;return String.fromCharCode(t)})}async function tts(){const t=parseInt(document.getElementById("rate").value),n=document.getElementById("searchText").value,s=kanaToHira(n),e=new MidiWriter.Track;e.setTempo(t),getNotes(moraMap,s).forEach(t=>{e.addEvent(new MidiWriter.ProgramChangeEvent({instrument:t.instrument})),e.addEvent(new MidiWriter.NoteEvent({pitch:t.pitch,duration:t.duration,velocity:t.velocity,wait:t.wait}))});const o=new MidiWriter.Writer(e),i=o.buildFile();await player.loadNoteSequence(i),play()}function resetPitch(){document.getElementById("pitch").value=60}function resetRate(){document.getElementById("rate").value=480}function resetVolume(){document.getElementById("volume").value=500}function loadLibraries(e){const t=e.map(e=>new Promise((t,n)=>{const s=document.createElement("script");s.src=e,s.async=!0,s.onload=t,s.onerror=n,document.body.appendChild(s)}));return Promise.all(t)}const moraMap=new Map;let controllerDisabled,timer,player,firstRun=!0;loadConfig(),initMoras(),initPlayer(),Module={};const JSSynthPromise=loadLibraries(["https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/dist/js-synthesizer.min.js","https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/externals/libfluidsynth-2.3.0-with-libsndfile.min.js"]);document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("search").onclick=tts,document.getElementById("volume").onchange=changeVolumebar,document.addEventListener("keydown",typeEvent),document.getElementById("resetPitch").onclick=resetPitch,document.getElementById("resetRate").onclick=resetRate,document.getElementById("resetVolume").onclick=resetVolume,document.addEventListener("click",unlockAudio)