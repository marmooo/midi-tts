function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}class SoundFontPlayer{constructor(a){this.context=new AudioContext,this.state="stopped",this.callStop=!1,this.stopCallback=a,this.prevGain=5,this.cacheUrls=new Array(128),this.totalTicks=0}async loadSoundFontDir(a,b){const c=a.map(a=>{const d=a.toString().padStart(3,"0"),c=`${b}/${d}.sf3`;return this.cacheUrls[a]==c||(this.cacheUrls[a]=c,this.fetchBuffer(c))}),d=await Promise.all(c);for(const a of d)a instanceof ArrayBuffer&&await this.loadSoundFontBuffer(a)}async fetchBuffer(b){const a=await fetch(b);return a.status==200?await a.arrayBuffer():void 0}async loadSoundFontUrl(a){const b=await this.fetchBuffer(a),c=await this.loadSoundFontBuffer(b);return c}async loadSoundFontBuffer(a){if(!this.synth){await JSSynthPromise,await this.context.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/externals/libfluidsynth-2.3.0-with-libsndfile.min.js"),await this.context.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/dist/js-synthesizer.worklet.min.js"),this.synth=new JSSynth.AudioWorkletNodeSynthesizer,this.synth.init(this.context.sampleRate);const a=this.synth.createAudioNode(this.context);a.connect(this.context.destination)}const b=await this.synth.loadSFont(a);return b}async loadNoteSequence(a){await this.synth.resetPlayer(),this.totalTicks=1/0;const b=document.getElementById("volume"),c=parseInt(b.value);return this.changeVolume(c),this.synth.addSMFDataToPlayer(a)}resumeContext(){this.context.resume()}async restart(a){this.state="started",await this.synth.playPlayer(),a&&this.seekTo(a),await this.synth.waitForPlayerStopped(),await this.synth.waitForVoicesStopped(),this.state="paused";const b=await this.synth.retrievePlayerCurrentTick();this.totalTicks<=b&&(player.seekTo(0),this.stopCallback())}async start(a,c,b){a&&await this.loadNoteSequence(a),b&&this.seekTo(b),this.restart()}stop(){this.isPlaying()&&this.synth.stopPlayer()}pause(){this.state="paused",this.synth.stopPlayer()}resume(a){this.restart(a)}changeVolume(a){a=a/100,this.synth.setGain(a)}changeMute(a){a?(this.prevGain=this.synth.getGain(),this.synth.setGain(0)):this.synth.setGain(this.prevGain)}calcTick(d){let a=0,b=0,c=120;for(const f of this.ns.tempos){const e=f.time,g=f.qpm;if(e<d){const d=e-b;a+=c/60*d*this.ns.ticksPerQuarter}else{const e=d-b;return a+=c/60*e*this.ns.ticksPerQuarter,Math.round(a)}b=e,c=g}const e=d-b;return a+=c/60*e*this.ns.ticksPerQuarter,Math.floor(a)}seekTo(a){const b=this.calcTick(a);this.synth.seekPlayer(b)}isPlaying(){return!!this.synth&&this.synth.isPlaying()}getPlayState(){return this.synth?this.synth.isPlaying()?"started":this.state:"stopped"}}function stopCallback(){clearInterval(timer),currentTime=0,currentPos=0,clearPlayer()}async function initPlayer(){disableController(),player&&player.isPlaying()&&player.stop(),currentTime=0,currentPos=0,player=new SoundFontPlayer(stopCallback),firstRun?(firstRun=!1,await loadSoundFont(player,"Ritsu_v0.0.2.sf3")):await loadSoundFont(player),enableController()}async function loadSoundFont(a,b){await a.loadSoundFontUrl(b)}function disableController(){controllerDisabled=!0;const a=document.getElementById("controller").querySelectorAll("button, input");[...a].forEach(a=>{a.disabled=!0})}function enableController(){controllerDisabled=!1;const a=document.getElementById("controller").querySelectorAll("button, input");[...a].forEach(a=>{a.disabled=!1})}function unlockAudio(){if(!player)return;if(!player.synth)return;player.resumeContext(),document.removeEventListener("click",unlockAudio)}function play(){player.start()}function changeVolumebar(){const a=document.getElementById("volume"),b=parseInt(a.value);a.dataset.value=b,player.changeVolume(b)}function clearPlayer(){clearInterval(timer)}function typeEvent(a){if(!player||!player.synth)return;if(controllerDisabled)return;player.resumeContext(),a.keyCode===13&&tts()}function initMoras(){fetch("mora.lst").then(a=>a.text()).then(a=>{a.trimEnd().split("\n").forEach((a,b)=>{moraMap.set(a,b)})})}function getNotes(d,b){const h=parseInt(document.getElementById("pitch").value),e=parseInt(document.getElementById("volume").value),i=2,a=[];let f=h,g=e,c="0";while(b.length>0){let j=!1;for(let k=i;0<k;k--){const l=b.slice(0,k);if(d.has(l)){const i={instrument:d.get(l),duration:"4",pitch:f,velocity:g,wait:c};a.push(structuredClone(i)),f=h,g=e,c="0",b=b.substring(l.length),j=!0;break}}if(!j){switch(b[0]){case" ":c="16";break;case"　":c="8";break;case"っ":c="4";break;case"…":case"･･･":case"、":case"､":case"，":case",":c="2n";break;case"。":case"｡":case"．":case".":c="1n";break;case"↑":case"↗":case"⤴":case"⇑":case"⇡":a.at(-1).pitch+=1;break;case"⬆":a.at(-1).pitch+=4;break;case"↓":case"↘":case"⤵":case"⇓":case"⇣":a.at(-1).pitch-=1;break;case"⬇":a.at(-1).pitch-=4;break;case"!":a.at(-1).velocity+=8;break;case"‼":case"!!":a.at(-1).velocity+=16;break;case"！":a.at(-1).velocity+=32;break;case"❗":case"❕":a.at(-1).velocity+=64;break;case"?":{const b=structuredClone(a.at(-1));b.duration="32",b.pitch+=1,a.push(b);break}case"??":case"?!":case"!?":case"？":case"❓":case"❔":{const b=structuredClone(a.at(-1));b.duration="16",b.pitch+=1,a.push(b);break}case"ー":a.at(-1).duration="2";break}b=b.substring(1)}}return a}function kanaToHira(a){return a.replace(/[\u30a1-\u30f6]/g,a=>{const b=a.charCodeAt(0)-96;return String.fromCharCode(b)})}async function tts(){const b=parseInt(document.getElementById("rate").value),c=document.getElementById("searchText").value,d=kanaToHira(c),a=new MidiWriter.Track;a.setTempo(b),getNotes(moraMap,d).forEach(b=>{a.addEvent(new MidiWriter.ProgramChangeEvent({instrument:b.instrument})),a.addEvent(new MidiWriter.NoteEvent({pitch:b.pitch,duration:b.duration,velocity:b.velocity,wait:b.wait}))});const e=new MidiWriter.Writer(a),f=e.buildFile();await player.loadNoteSequence(f),play()}function resetPitch(){document.getElementById("pitch").value=60}function resetRate(){document.getElementById("rate").value=480}function resetVolume(){document.getElementById("volume").value=500}function loadLibraries(a){const b=a.map(a=>new Promise((c,d)=>{const b=document.createElement("script");b.src=a,b.async=!0,b.onload=c,b.onerror=d,document.body.appendChild(b)}));return Promise.all(b)}const moraMap=new Map;let controllerDisabled,timer,player,firstRun=!0;loadConfig(),initMoras(),initPlayer(),Module={};const JSSynthPromise=loadLibraries(["https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/dist/js-synthesizer.min.js","https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/externals/libfluidsynth-2.3.0-with-libsndfile.min.js"]);document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("search").onclick=tts,document.getElementById("volume").onchange=changeVolumebar,document.addEventListener("keydown",typeEvent),document.getElementById("resetPitch").onclick=resetPitch,document.getElementById("resetRate").onclick=resetRate,document.getElementById("resetVolume").onclick=resetVolume,document.addEventListener("click",unlockAudio)